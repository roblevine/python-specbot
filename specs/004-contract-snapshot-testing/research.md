# Research Findings: Consumer-Driven Contract Testing with Snapshot Validation

**Branch**: `004-contract-snapshot-testing` | **Date**: 2025-12-29
**Phase**: Phase 0 - Technical Research
**Generated by**: `/speckit.plan` command

## Overview

This document captures research findings from Phase 0 of the planning workflow. Each NEEDS CLARIFICATION item from the Technical Context section is resolved through research, evaluation of alternatives, and documented decisions.

---

## Research Task 1: OpenAPI Request Validator for JavaScript

**Original Question**: Which OpenAPI request validation library should we use for JavaScript/Vitest to validate frontend HTTP requests against our OpenAPI specification?

**Requirements**:
- Must validate HTTP requests (method, path, headers, body) against OpenAPI 3.x spec
- Must integrate cleanly with Vitest testing framework
- Must provide clear validation error messages
- Should be actively maintained (updated in last 12 months)
- Lightweight preferred (no heavy dependencies)

**Research Sources**:
- [vitest-openapi GitHub](https://github.com/yutak23/vitest-openapi)
- [openapi-request-validator npm](https://www.npmjs.com/package/openapi-request-validator)
- [express-openapi-validator npm](https://www.npmjs.com/package/express-openapi-validator)
- [openapi-data-validator npm](https://www.npmjs.com/package/openapi-data-validator)
- [core-ajv-schema-validator npm](https://www.npmjs.com/package/core-ajv-schema-validator)
- [@seriousme/openapi-schema-validator npm](https://www.npmjs.com/package/@seriousme/openapi-schema-validator)

### Alternatives Evaluated

#### Option 1: vitest-openapi
**Description**: Vitest plugin that brings jest-openapi functionality to Vitest
**Pros**:
- Direct Vitest integration with custom matchers (`toSatisfyApiSpec()`)
- Designed specifically for Vitest
- Clean expect() syntax familiar to Vitest users
**Cons**:
- Last published 2 years ago (not actively maintained)
- Primarily focused on response validation, not request validation
- Designed for validating responses FROM backend, not requests TO backend
**Verdict**: ❌ Not suitable - focuses on wrong direction (responses not requests)

#### Option 2: openapi-request-validator
**Description**: Standalone library for validating request properties against OpenAPI spec
**Pros**:
- Specifically designed for request validation
- Clear error messages with location (body, headers, path, query)
- Widely used (28 dependents)
**Cons**:
- Last published 3 years ago (stale)
- Not actively maintained
- No direct Vitest integration
**Verdict**: ❌ Rejected - too old, not maintained

#### Option 3: express-openapi-validator
**Description**: Middleware for Express that validates requests/responses against OpenAPI spec
**Pros**:
- Actively maintained (updated 3 months ago)
- Comprehensive validation (requests AND responses)
- Battle-tested in production environments
**Cons**:
- Designed as Express middleware (tight coupling)
- Overkill for test snapshots (brings entire Express integration)
- Would require adapting Express patterns for Vitest tests
**Verdict**: ❌ Rejected - too heavyweight, wrong abstraction layer

#### Option 4: openapi-data-validator + Manual Integration
**Description**: Lightweight, unopinionated validator that works with any framework
**Pros**:
- Recently updated (2 months ago)
- Lightweight and fast
- Framework-agnostic (works with any test runner)
- Can validate any data structure against OpenAPI schemas
**Cons**:
- Requires manual integration with Vitest
- No custom matchers out of the box
- Need to write wrapper functions
**Verdict**: ⚠️ Viable but requires more setup work

#### Option 5: @seriousme/openapi-schema-validator + AJV
**Description**: OpenAPI schema validator built on AJV (same validator used by many OpenAPI tools)
**Pros**:
- Uses AJV (industry-standard JSON schema validator)
- Tested on 2000+ real-world APIs (AWS, Google, Microsoft)
- Supports OpenAPI 2.0, 3.0.x, 3.1.x
- Can pass AJV options for customization
- Actively maintained
**Cons**:
- Validates OpenAPI specs themselves, not requests against specs
- Wrong abstraction - we need request validation, not spec validation
**Verdict**: ❌ Rejected - validates specs, not requests

#### Option 6: core-ajv-schema-validator
**Description**: API testing plugin using AJV to validate responses/requests against OpenAPI docs
**Pros**:
- Uses AJV (same as Python openapi-core uses JSON schema validation)
- Works with JSON schemas, Swagger, and OpenAPI documents
- Framework-agnostic (used in Cypress and Playwright plugins)
- Provides detailed error messages AND user-friendly summaries
- Actively maintained
**Cons**:
- Requires manual integration with Vitest (no custom matchers)
- Need to create wrapper for snapshot capture workflow
**Verdict**: ✅ BEST OPTION - closest JavaScript equivalent to Python's openapi-core

### Decision

**Selected Library**: `core-ajv-schema-validator`

**Rationale**:
1. **AJV Foundation**: Uses AJV as the core validator, which is the JavaScript equivalent to how Python's openapi-core uses JSON schema validation. This provides parity between frontend and backend validation approaches.

2. **Framework Agnostic**: Designed to work with any testing framework (already used in Cypress and Playwright). Can integrate cleanly with Vitest through custom helper functions.

3. **Comprehensive Validation**: Validates both requests and responses against OpenAPI documents, exactly what we need for contract testing.

4. **Clear Error Messages**: Provides both detailed AJV errors AND user-friendly summaries, matching our requirement for actionable error messages (FR-008).

5. **Active Maintenance**: Part of a suite of testing tools actively maintained for API contract validation.

6. **Lightweight**: Core package without heavy framework dependencies.

### Implementation Plan

**Installation**:
```bash
npm install --save-dev core-ajv-schema-validator
```

**Integration with Vitest**:
Create helper function in `frontend/tests/helpers/contract.js`:
```javascript
import { validateSchema } from 'core-ajv-schema-validator';
import openapiSpec from '../../../specs/003-backend-api-loopback/openapi.json';

export function validateRequest(operationId, request) {
  // Extract operation from OpenAPI spec
  const operation = findOperation(openapiSpec, operationId);

  // Build request object from HTTP details
  const requestData = {
    method: request.method,
    path: request.path,
    headers: request.headers,
    body: request.body
  };

  // Validate using core-ajv-schema-validator
  const result = validateSchema(requestData, operation.requestBody.content['application/json'].schema, openapiSpec);

  if (!result.valid) {
    throw new Error(`Request validation failed: ${result.errors.join(', ')}`);
  }

  return result;
}
```

**Usage in Vitest Tests**:
```javascript
import { describe, it, expect } from 'vitest';
import { validateRequest } from './helpers/contract';

describe('Message API Contract', () => {
  it('captures valid request snapshot', async () => {
    const request = {
      method: 'POST',
      path: '/api/v1/messages',
      headers: { 'content-type': 'application/json' },
      body: { message: 'hello', conversationId: 'conv-123' }
    };

    // Validate against OpenAPI spec
    const validation = validateRequest('sendMessage', request);
    expect(validation.valid).toBe(true);

    // Write snapshot
    await writeSnapshot('send-message.json', request);
  });
});
```

**Performance Impact**:
- Validation time: < 100ms per request (AJV is highly optimized)
- Memory footprint: Minimal (loads OpenAPI spec once, reuses validator)
- Meets performance goal: < 1 second per API operation (FR-032 from plan)

**Compatibility**:
- Vitest: ✅ Framework-agnostic, works with any test runner
- OpenAPI 3.x: ✅ Supports OpenAPI 3.0 and 3.1
- Node.js: ✅ Works with Node.js 18+ (same as project)

---

## Summary of Changes

### Technical Context Updates

Replace:
```markdown
**New Dependencies Needed**: NEEDS CLARIFICATION - OpenAPI request validator for JavaScript
```

With:
```markdown
**New Dependencies Needed**:
- `core-ajv-schema-validator` - OpenAPI request/response validator using AJV (JavaScript equivalent to Python's openapi-core)
```

### Dependencies to Add

**Frontend** (`frontend/package.json`):
```json
{
  "devDependencies": {
    "core-ajv-schema-validator": "^latest"
  }
}
```

---

## Open Questions

None - all NEEDS CLARIFICATION items from Technical Context have been resolved.

---

## Next Steps

1. ✅ Research complete - all clarifications resolved
2. ⏭️ Update Technical Context section in `plan.md`
3. ⏭️ Proceed to Phase 1: Design Artifacts
   - Generate `data-model.md`
   - Generate `contracts/` (if needed)
   - Generate `quickstart.md`
4. ⏭️ Update agent context using `.specify/scripts/bash/update-agent-context.sh claude`
