# Data Model: New Conversation Button

**Feature**: 002-new-conversation-button
**Date**: 2025-12-25
**Status**: Complete

## Overview

This feature does not introduce new data models. It reuses existing data structures from the 001-chat-interface feature. This document describes the existing models and their relationship to the new conversation button feature.

## Existing Data Models (Reused)

### Conversation Entity

**Source**: Defined in `frontend/src/state/useConversations.js` (line 29-37)

**Structure**:
```javascript
{
  id: string,              // Unique identifier (format: "conv_<timestamp>_<random>")
  createdAt: string,       // ISO 8601 timestamp
  updatedAt: string,       // ISO 8601 timestamp
  messages: Message[],     // Array of message objects
  title: string            // Display title (default: "New Conversation")
}
```

**Fields**:
- **id**: Unique conversation identifier
  - Generated by `generateId('conv')` utility
  - Format: `conv_<timestamp>_<random>`
  - Immutable after creation

- **createdAt**: Timestamp when conversation was created
  - ISO 8601 format (e.g., "2025-12-25T12:00:00.000Z")
  - Set once during creation
  - Immutable

- **updatedAt**: Timestamp of last modification
  - ISO 8601 format
  - Updated when messages are added
  - Used for sorting conversations (most recent first)

- **messages**: Array of message objects
  - Can be empty (new conversations start with empty array)
  - See Message Entity below

- **title**: Human-readable conversation title
  - Default value: "New Conversation"
  - Auto-updated from first message (first 50 characters)
  - Used in HistoryBar display

**Validation Rules** (enforced by `validateConversation()`):
- `id` must be a non-empty string
- `createdAt` must be valid ISO 8601 string
- `updatedAt` must be valid ISO 8601 string
- `messages` must be an array
- `title` must be a non-empty string

**Relationships**:
- **Has Many**: Messages (one-to-many)
- **Belongs To**: None (top-level entity)

---

### Message Entity

**Source**: Defined in message handling code, validated by `validateMessage()`

**Structure**:
```javascript
{
  id: string,              // Unique identifier
  role: string,            // "user" or "assistant"
  text: string,            // Message content
  timestamp: string        // ISO 8601 timestamp
}
```

**Fields**:
- **id**: Unique message identifier
  - Generated by `generateId('msg')` utility
  - Format: `msg_<timestamp>_<random>`
  - Immutable after creation

- **role**: Message sender type
  - Enum: "user" | "assistant"
  - "user" = message sent by user
  - "assistant" = response from system (loopback in P1)

- **text**: Message content
  - Non-empty string
  - User input or system response
  - No length limit enforced (frontend only)

- **timestamp**: When message was created
  - ISO 8601 format
  - Used for chronological ordering
  - Immutable

**Validation Rules** (enforced by `validateMessage()`):
- `id` must be a non-empty string
- `role` must be either "user" or "assistant"
- `text` must be a non-empty string
- `timestamp` must be valid ISO 8601 string

**Relationships**:
- **Belongs To**: Conversation (many-to-one)

---

## State Models (Vue Reactive State)

### Conversations State

**Source**: `frontend/src/state/useConversations.js`

**Reactive References**:
```javascript
const conversations = ref([])           // Array<Conversation>
const activeConversationId = ref(null)  // string | null
```

**Computed Properties**:
```javascript
const activeConversation = computed(() => ...)  // Conversation | null
```

**Description**:
- **conversations**: Array of all conversation objects
  - Singleton state (shared across all component instances)
  - Reactive - UI updates automatically when modified
  - Persisted to LocalStorage

- **activeConversationId**: ID of currently active conversation
  - `null` when no conversation is active (rare)
  - Points to a conversation in the `conversations` array
  - Determines which conversation's messages are displayed

- **activeConversation**: Computed property
  - Finds conversation matching `activeConversationId`
  - Returns `null` if not found
  - Read-only (computed from other state)

**State Mutations**:
- `createConversation()`: Adds new conversation to array, sets as active
- `addMessage()`: Pushes message to conversation's messages array
- `loadFromStorage()`: Replaces entire conversations array from storage
- `saveToStorage()`: Persists conversations array to LocalStorage

---

## Storage Schema (LocalStorage)

**Key**: `chatbot_conversations`

**Value**: JSON string

**Deserialized Structure**:
```javascript
{
  conversations: Conversation[],  // Array of conversation objects
  activeConversationId: string    // ID of active conversation
}
```

**Storage Adapter**: `frontend/src/storage/LocalStorageAdapter.js`

**Functions**:
- `saveConversations(conversations, activeId)`: Serializes and saves
- `loadConversations()`: Loads and deserializes, returns default if missing

**Persistence Behavior**:
- Empty conversations (0 messages) are filtered out before save
- Storage is updated after every message send
- Storage is loaded once on app initialization

---

## Data Flow for New Conversation Button

### State Transitions

**Initial State**:
```javascript
conversations = [
  { id: "conv_001", messages: [...], title: "Previous Conversation" }
]
activeConversationId = "conv_001"
```

**User Clicks "New Conversation" Button**:

1. HistoryBar emits `new-conversation` event
2. App component calls `createConversation()`
3. `createConversation()` executes:
   ```javascript
   const newConv = {
     id: generateId('conv'),  // e.g., "conv_1735135200000_a1b2c3"
     createdAt: "2025-12-25T12:00:00.000Z",
     updatedAt: "2025-12-25T12:00:00.000Z",
     messages: [],
     title: "New Conversation"
   }
   conversations.value.push(newConv)
   activeConversationId.value = newConv.id
   ```
4. App component calls `saveToStorage()`
5. Vue reactivity triggers UI updates:
   - HistoryBar re-renders with new conversation in list
   - ChatArea clears (new conversation has no messages)
   - InputArea remains ready for input

**Final State**:
```javascript
conversations = [
  { id: "conv_001", messages: [...], title: "Previous Conversation" },
  { id: "conv_1735135200000_a1b2c3", messages: [], title: "New Conversation" }
]
activeConversationId = "conv_1735135200000_a1b2c3"
```

---

## No New Data Models Required

This feature does not require:
- ❌ New entity types
- ❌ New fields on existing entities
- ❌ New validation rules
- ❌ Database schema changes (frontend only, no DB)
- ❌ New storage keys

It only requires:
- ✅ New UI component (button)
- ✅ New event emission
- ✅ New event handler
- ✅ Reuse of existing `createConversation()` function

---

## Validation

### Existing Validators (Reused)

**File**: `frontend/src/utils/validators.js`

**Functions**:
- `validateConversation(conversation)`: Returns `{ isValid: boolean, error: string }`
- `validateMessage(message)`: Returns `{ isValid: boolean, error: string }`

**Usage in Feature**:
- `createConversation()` validates new conversation before adding to state
- If validation fails, throws error (caught by App component error handler)
- No new validation logic needed for button feature

---

## Summary

**Data Model Impact**: None (reuses existing models)

**State Changes**: Creates new Conversation entity via existing `createConversation()` function

**Storage Impact**: New conversation added to LocalStorage conversations array

**No Schema Changes**: Feature uses 100% existing data structures
